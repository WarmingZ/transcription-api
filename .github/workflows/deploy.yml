name: Deploy Transcription API

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg libsndfile1
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run basic tests
      run: |
        # Ð¢ÐµÑÑ‚ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ Ð¼Ð¾Ð´ÑƒÐ»Ñ–Ð²
        python -c "import main; import models.config; import models.whisper_model; import models.diarization; import models.transcription_service"
        echo "âœ… Ð’ÑÑ– Ð¼Ð¾Ð´ÑƒÐ»Ñ– Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚ÑƒÑŽÑ‚ÑŒÑÑ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾"
    
    - name: Lint code
      run: |
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸ Ð›Ñ–Ð½Ñ‚Ñ–Ð½Ð³ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ Ð· Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð¶ÐµÐ½Ð½ÑÐ¼Ð¸"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/main') || startsWith(github.ref, 'refs/heads/production')
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 600s
        command_timeout: 300s
        script: |
          echo "ðŸš€ ÐŸÐ¾Ñ‡Ð°Ñ‚Ð¾Ðº Ð´ÐµÐ¿Ð»Ð¾ÑŽ Transcription API..."
          
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° SSH Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ
          echo "ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° SSH Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ..."
          whoami
          pwd
          echo "âœ… SSH Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð¿Ñ€Ð°Ñ†ÑŽÑ”"
          
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
          sudo mkdir -p /opt/transcription-api
          sudo chown ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /opt/transcription-api
          
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–ÑŽ
          cd /opt/transcription-api
          
          # Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ Ñ„Ð°Ð¹Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· wget (Ð¾ÑÐºÑ–Ð»ÑŒÐºÐ¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–Ð¹ Ð¼Ð¾Ð¶Ðµ Ð±ÑƒÑ‚Ð¸ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¸Ð¼)
          echo "ðŸ“¥ Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ..."
          
          # ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ñ„Ð°Ð¹Ð»Ð¸
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/main.py
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/requirements.txt
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/download_models.py
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/SETUP.md
          
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–ÑŽ models
          mkdir -p models
          
          # Ð¤Ð°Ð¹Ð»Ð¸ Ð· models
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/models/__init__.py -P models/
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/models/config.py -P models/
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/models/whisper_model.py -P models/
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/models/diarization.py -P models/
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/models/transcription_service.py -P models/
          
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ—
          mkdir -p static temp logs
          
          # Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡Ð½Ñ– Ñ„Ð°Ð¹Ð»Ð¸
          wget -q https://raw.githubusercontent.com/WarmingZ/transcription-api/main/static/index.html -P static/
          
          echo "âœ… Ð¤Ð°Ð¹Ð»Ð¸ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾"
          
          # Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Python Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ– Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–
          echo "ðŸ“¦ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¸Ñ… Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹..."
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv ffmpeg libsndfile1 libsndfile1-dev
          
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð²Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ðµ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ðµ
          echo "ðŸ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð²Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð°..."
          python3 -m venv venv
          source venv/bin/activate
          
          # Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Python Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–
          echo "ðŸ“š Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Python Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ Ð¼Ð¾Ð´ÐµÐ»Ñ– (ÑÐºÑ‰Ð¾ Ñ‰Ðµ Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ñ–)
          echo "ðŸ¤– Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹..."
          if [ ! -d "models/faster-whisper-medium" ]; then
            python3 download_models.py || echo "âš ï¸ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹"
          else
            echo "âœ… ÐœÐ¾Ð´ÐµÐ»Ñ– Ð²Ð¶Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ñ–"
          fi
          
          # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ systemd ÑÐµÑ€Ð²Ñ–Ñ
          echo "âš™ï¸ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ systemd ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
          sudo tee /etc/systemd/system/transcription-api.service > /dev/null << EOF
[Unit]
Description=Transcription API Service
After=network.target

[Service]
Type=simple
User=deploy
Group=deploy
WorkingDirectory=/opt/transcription-api
Environment=API_KEY=your-secret-api-key-here
ExecStart=/opt/transcription-api/venv/bin/python main.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

          # ÐŸÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ systemd Ñ‚Ð° Ð²Ð¼Ð¸ÐºÐ°Ñ”Ð¼Ð¾ ÑÐµÑ€Ð²Ñ–Ñ
          echo "ðŸ”„ ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ systemd ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
          sudo systemctl daemon-reload
          sudo systemctl enable transcription-api.service
          
          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ ÑÐµÑ€Ð²Ñ–Ñ
          echo "ðŸ›‘ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
          sudo systemctl restart transcription-api.service
          
          # Ð§ÐµÐºÐ°Ñ”Ð¼Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÑƒ
          echo "â³ ÐžÑ‡Ñ–ÐºÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð°Ð¿ÑƒÑÐºÑƒ ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
          sleep 5
          
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ñ‰Ð¾ ÑÐµÑ€Ð²Ñ–Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸Ð¹
          echo "ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ systemd ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
          if sudo systemctl is-active --quiet transcription-api.service; then
            echo "âœ… Ð¡ÐµÑ€Ð²Ñ–Ñ transcription-api Ð¿Ñ€Ð°Ñ†ÑŽÑ”"
          else
            echo "âŒ Ð¡ÐµÑ€Ð²Ñ–Ñ transcription-api Ð½Ðµ ÑÑ‚Ð°Ñ€Ñ‚ÑƒÐ²Ð°Ð²"
            sudo journalctl -u transcription-api.service --no-pager -n 20
            exit 1
          fi
          
          # ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ”Ð¼Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð´Ð»Ñ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ—
          sudo systemctl status transcription-api.service --no-pager || true
          
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ API
          echo "ðŸŒ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° API..."
          if curl -f http://localhost:8000/health; then
            echo "âœ… Ð¡ÐµÑ€Ð²Ñ–Ñ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¸Ð¹ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾!"
            echo "ðŸŒ API Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ðµ Ð·Ð° Ð°Ð´Ñ€ÐµÑÐ¾ÑŽ: http://176.9.9.106:8000"
            echo "ðŸ“Š Ð’ÐµÐ±-Ñ–Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ: http://176.9.9.106:8000"
            echo "ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ñ–Ñ API: http://176.9.9.106:8000/docs"
            echo "ðŸ“‹ Ð›Ð¾Ð³Ð¸ ÑÐµÑ€Ð²Ñ–ÑÑƒ: sudo journalctl -u transcription-api.service -f"
            echo "ðŸ”„ Ð£Ð¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ ÑÐµÑ€Ð²Ñ–ÑÐ¾Ð¼:"
            echo "   sudo systemctl start transcription-api.service"
            echo "   sudo systemctl stop transcription-api.service"
            echo "   sudo systemctl restart transcription-api.service"
            echo "   sudo systemctl status transcription-api.service"
          else
            echo "âŒ API Ð½Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ”"
            echo "ðŸ“‹ ÐžÑÑ‚Ð°Ð½Ð½Ñ– Ð»Ð¾Ð³Ð¸ systemd:"
            sudo journalctl -u transcription-api.service --no-pager -n 20
            exit 1
          fi
          
          echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾!"
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸ Ð·Ð±ÐµÑ€Ñ–Ð³Ð°ÑŽÑ‚ÑŒÑÑ Ð² systemd journal"
          echo "ðŸ”„ Ð£Ð¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ ÑÐµÑ€Ð²Ñ–ÑÐ¾Ð¼:"
          echo "   sudo systemctl restart transcription-api.service"
          echo "   sudo systemctl status transcription-api.service"
          echo "   sudo journalctl -u transcription-api.service -f"
