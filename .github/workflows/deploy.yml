name: Deploy Transcription API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 900s
        command_timeout: 600s
        script: |
          echo "üöÄ –î–µ–ø–ª–æ–π Ukrainian Transcription API"
          echo "======================================"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –¥–æ–º–∞—à–Ω—é –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é root
          cd /root
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
          mkdir -p transcription-api
          cd transcription-api
          
          # –ö–ª–æ–Ω—É—î–º–æ –∞–±–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
          if [ ! -d ".git" ]; then
            echo "üì• –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é..."
            git clone https://github.com/WarmingZ/transcription-api.git .
          else
            echo "üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É..."
            git pull origin main
          fi
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
          echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
          apt-get update -qq
          apt-get install -y curl software-properties-common git python3.10 python3.10-venv python3.10-dev python3-pip
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
          echo "üì¶ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞..."
          if [ ! -d "venv" ]; then
            python3.10 -m venv venv
          fi
          
          # –ê–∫—Ç–∏–≤—É—î–º–æ venv
          source venv/bin/activate
          
          # –û–Ω–æ–≤–ª—é—î–º–æ pip/setuptools/wheel
          pip install --upgrade pip setuptools wheel
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
          echo "üìö –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Python –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
          pip install numpy
          pip install git+https://github.com/dofuuz/python-soxr.git
          pip install -r requirements.txt
          
          # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º–æ–¥–µ–ª—ñ
          echo "ü§ñ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π..."
          if [ ! -d "models/faster-whisper-medium" ]; then
            python download_models.py
          else
            echo "‚úÖ –ú–æ–¥–µ–ª—ñ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ"
          fi
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
          mkdir -p logs temp
          
          # –ó—É–ø–∏–Ω—è—î–º–æ —Å—Ç–∞—Ä–∏–π –ø—Ä–æ—Ü–µ—Å
          echo "üõë –ó—É–ø–∏–Ω–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É..."
          pkill -f "python main.py" || true
          sleep 3
          
          # –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å
          echo "üöÄ –ó–∞–ø—É—Å–∫ API..."
          nohup venv/bin/python main.py > logs/app.log 2>&1 &
          echo $! > logs/app.pid
          
          # –ß–µ–∫–∞—î–º–æ –∑–∞–ø—É—Å–∫—É
          echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É (15 —Å–µ–∫—É–Ω–¥)..."
          sleep 15
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É API..."
          if curl -f http://localhost:8000/health; then
            echo ""
            echo "‚úÖ –î–ï–ü–õ–û–ô –£–°–ü–Ü–®–ù–ò–ô!"
            echo "üåê API –¥–æ—Å—Ç—É–ø–Ω–µ: http://176.9.9.106:8000"
            echo "üìä –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://176.9.9.106:8000"
            echo "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è: http://176.9.9.106:8000/docs"
            echo "üìÅ –ü—Ä–æ–µ–∫—Ç: /root/transcription-api"
            echo "üìã –õ–æ–≥–∏: /root/transcription-api/logs/app.log"
            echo ""
            echo "üîÑ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å–æ–º:"
            echo "   cd /root/transcription-api"
            echo "   pkill -f 'python main.py'  # –∑—É–ø–∏–Ω–∏—Ç–∏"
            echo "   nohup venv/bin/python main.py > logs/app.log 2>&1 &  # –∑–∞–ø—É—Å—Ç–∏—Ç–∏"
            echo ""
          else
            echo "‚ùå –ü–û–ú–ò–õ–ö–ê –ó–ê–ü–£–°–ö–£!"
            echo "üìã –û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:"
            tail -20 logs/app.log
            echo ""
            echo "üîß –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
            echo "   ps aux | grep python"
            echo "   netstat -tlnp | grep 8000"
            exit 1
          fi
