name: Deploy API

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "üöÄ –î–µ–ø–ª–æ–π API..."
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ sudo —è–∫—â–æ –Ω–µ–º–∞—î
          if ! command -v sudo &> /dev/null; then
            apt-get update
            apt-get install -y sudo
          fi
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ–µ–∫—Ç—É
          sudo mkdir -p /opt/transcription-api
          sudo chown ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /opt/transcription-api
          cd /opt/transcription-api
          
          # –ö–ª–æ–Ω—É—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π —è–∫—â–æ –Ω–µ–º–∞—î
          if [ ! -d ".git" ]; then
            git clone https://github.com/WarmingZ/transcription-api.git .
          else
            git pull origin main
          fi
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
          sudo apt-get update -qq
          sudo apt-get install -y python3 python3-pip python3-venv ffmpeg libsndfile1
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ venv
          python3 -m venv venv
          source venv/bin/activate
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Python –ø–∞–∫–µ—Ç–∏
          pip install --upgrade pip -q
          pip install -r requirements.txt -q
          
          # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º–æ–¥–µ–ª—ñ
          python3 download_models.py || echo "‚ö†Ô∏è –ú–æ–¥–µ–ª—ñ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ"
          
          # –ó—É–ø–∏–Ω—è—î–º–æ —Å—Ç–∞—Ä–∏–π –ø—Ä–æ—Ü–µ—Å
          pkill -f "python3 main.py" || true
          sleep 2
          
          # –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–æ–≤–∏–π
          nohup python3 main.py > logs/app.log 2>&1 &
          echo $! > logs/app.pid
          
          # –ß–µ–∫–∞—î–º–æ
          sleep 10
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ
          if curl -f http://localhost:8000/health; then
            echo "‚úÖ API –ø—Ä–∞—Ü—é—î!"
            echo "üåê http://176.9.9.106:8000"
          else
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É"
            cat logs/app.log
            exit 1
          fi